<section id = "showcase" class="row">
  <div class="col-md-12">
    <div id="Carousel" class="center carousel slide" data-ride="carousel">
      <!-- Indicators -->
      <ol class="carousel-indicators">
        <li data-target="#Carousel" data-slide-to="0" class="active"></li>
        <% (1..@market.market_images.length-1).each do |i|%>
        <li data-target="#Carousel" data-slide-to="<%= i %>"></li>
        <% end %>
      </ol>

      <!-- Wrapper for Slides -->
      <div class="carousel-inner">
        <% if @market.market_images.all.length == 0 %>
        <div class="item active">
          <div class="text-center carousel-image carousel-image-lg" style="background:url('/bg_default_market2.png');      background-size: 100% 100%;
                background-repeat: no-repeat;"><span class="glyphicon-lg glyphicon glyphicon glyphicon-bullhorn"></span></div>
        </div>
        <% else %>
        <div class="item active">
          <div class="text-center carousel-image carousel-image-lg" style="background:url(<%=  @market.market_images.all.first.image.url(:large) %>;      background-size: 100% 100%;
                background-repeat: no-repeat;)"></div>

        </div>
        <% @market.market_images[1..-1].each do |market_image|%>
        <div class="item">
          <div class="text-center carousel-image carousel-image-lg" style="background:url(<%=  market_image.image.url(:large) %>);      background-size: 100% 100%;
                background-repeat: no-repeat;"></div>

        </div>
        <% end %>
        <% end %>
        <!-- Controls -->
        <a class="left carousel-control" href="#Carousel" data-slide="prev">
          <span class="icon-prev"></span>
        </a>
        <a class="right carousel-control" href="#Carousel" data-slide="next">
          <span class="icon-next"></span>
        </a>
      </div>
    </div><!--slider-->
  </div>
</section>

<section class="row information">
  <div class="col-sm-12 panel panel-default">
    <div class="col-sm-4 well">
      <div id="rating">
        <h4>Average user rating</h4>
        <h2 class="bold padding-bottom-7"><%= @market.rating%> <small>/ 5</small></h2>
        <% (0..4).each do |i|%>
        <% if i >= @market.rating %>
        <button type="button" class="btn btn-default btn-sm" aria-label="Left Align">
          <span class="glyphicon glyphicon-star" aria-hidden="true"></span>
        </button>
        <% else %>
        <button type="button" class="btn btn-warning btn-sm" aria-label="Left Align">
          <span class="glyphicon glyphicon-star" aria-hidden="true"></span>
        </button>
        <% end %>
        <% end %>
      </div>
      <div class="alert alert-success"><%= link_to "Owner :" + @market.user.name, @market.user, class: "text-success" %></div>
    </div>


    <div class="col-sm-8">
      <div class="col-sm-12">
        <h2><%= @market.name %>
        </h2>
      </div>
      <input type="hidden" id="market_id" value="<%= @market.id %>">
      <div class="col-sm-12">
        <table class="table">
          <tbody>
            <tr>
              <td class = "col-sm-2 well"><strong>Address</strong></td>
              <td><%= @market.address%>, <%= @market.city %>, <%= @market.state%>, <%= @market.zipcode %></td>
            </tr>
            <tr>
              <td class = "col-sm-2 well"><strong>Open time</strong></td>
              <td><%= get_day_from_timestamp(@market.open_time) %><%= get_time_from_timestamp(@market.open_time) %> - <%= get_time_from_timestamp(@market.close_time) %></td>
            </tr>
            <tr>
              <td class = "col-sm-2 well"><strong>Description</strong></td>
              <td><%= @market.description %></td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="row management-board">
        <div class="col-sm-12">
          <% if isMarketOwner(@market) %>
          <div class="col-sm-4"><%= link_to 'Edit Info', edit_market_path, class: "btn btn-success btn-lg btn-space col-sm-12" %></div>

          <% if isVendor %>
          <% if joined_in?(@market) %>
          <div class="col-sm-4"><%= link_to 'Quit Market', StoreMarketRelationship.where(:store_id => current_user.vendor.store.id, :market_id => @market.id).first, method: :delete, class: "btn btn-danger  btn-lg btn-space col-sm-12", data: { confirm: t('messages.Are you sure quit this market'), ok: t('buttons.Sure'), cancel: t('buttons.cancel')}%></div>
          <% else %>
          <div class="col-sm-4"><div id="sendRelationship" class="btn btn-success btn-lg btn-space col-sm-12" data-toggle= "modal" data-target= "#sendMessagePanel">Join Market</div></div>
          <% end %>
          <% end %>
          <div class="col-sm-4"><%= link_to 'Delete', @market, method: :delete, class: "btn btn-danger  btn-lg btn-space col-sm-12", data: { confirm: t('messages.Are you sure delete this market'), ok: t('buttons.Sure'), cancel: t('buttons.cancel')}%></div>

          <% else %>

          <% if isVendor %>
          <% if joined_in?(@market) %>
          <div class="col-sm-12"><%= link_to 'Quit Market',  StoreMarketRelationship.where(:store_id => current_user.vendor.store.id, :market_id => @market.id).first, method: :delete, class: "btn btn-danger  btn-lg btn-space col-sm-12", data: { confirm: t('messages.Are you sure quit this market'), ok: t('buttons.Sure'), cancel: t('buttons.cancel')}%></div>
          <% else %>
          <div class="col-sm-12"><div id="sendRequest" class="btn btn-success btn-lg btn-space col-sm-12" data-toggle= "modal" data-target= "#sendMessagePanel">Join Market</div></div>
          <% end %>
          <% end %>
          <% end %>
        </div>
      </div>

    </div>
  </div>
</section>

<section class="row">
  <div class="col-sm-12">
    <div id="market_details" class="carousel slide details" >
      <ul class="nav nav-pills nav-justified">
        <li data-target="#market_details" data-slide-to="0" class="active"><a href="#">Store</a></li>
        <li data-target="#market_details" data-slide-to="1"><a href="#">Review</a></li>
      </ul>

      <!-- Wrapper for slides -->
      <div class="carousel-inner">
        <div class="item active">
          <div id = "market_stores">
            <%= render 'shared/stores', locals: { stores: @stores } %>
          </div>
          <div id="stores_next" class="btn btn-default col-sm-12">Show More Stores</div>
          <input type="hidden" id="current_store_page" value="<%= @current_page %>">
        </div><!-- End Item -->

        <div class="item">
          <% if logged_in? and !isMarketOwner(@market)%>
          <div class="row">
            <div class="col-md-12">
              <%= form_for(@review) do |f| %>

              <div class="form-group">
                <%= f.text_area :comment, {:class => "form-control", :rows => "5", :placeholder => "Enter your review here..."}%>
              </div>
              <div class="form-group">
                <div class="col-sm-12 well">
                  <div id="ratings" class="starrr col-sm-4 "></div>
                  <div id="ratings-notice" class="text-right">You gave a rating of <span id="count">0</span> star(s)</div>
                  <%= f.hidden_field :rating, {:value => 0}%>
                  <%= f.hidden_field :market_id, {:value => @market.id}%>
                </div>
              </div>

              <div class="form-group">
                <div class="actions">
                  <%= f.submit "Submit", {:class => "btn btn-success col-sm-12"}%></div>
                </div>
                <% end %>
              </div>
            </div>
            <hr>
            <% end %>

            <div id = "market_reviews" class="text-center">
              <%= render 'shared/reviews', locals: { reviews: @reviews } %>
            </div>
            <div id="reviews_next" class="btn btn-default col-sm-12">Show More Review</div>
            <input type="hidden" id="current_review_page" value="<%= @current_page %>">
          </div><!-- End Item -->

        </div><!-- End Carousel Inner -->
      </div>
    </div>
  </section>
  <div class="modal fade" id="sendMessagePanel" tabindex="-1" role="dialog" aria-labelledby="sendMessagePanelLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div id="modal-content" class="modal-content">

      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->
  <script>
  $(document).ready(function(){
    $('#new_market_review').submit(function() {
      document.getElementById("market_review_rating").value= (document.getElementById("count").innerHTML);
      return true; // return false to cancel form action
    });


    $('#sendRelationship').click(function(){

      $.ajax({
        url: "/store_market_relationships/new",
        dataType: "html",
        type: "GET",
        data: {market_id: $("#market_id").val()},
        success: function(data, success) {
          $('#modal-content').empty()
          $('#modal-content').append(data);
        },
        error: function(data, failure) {
          alert(data);
        }
      });
    });

    $('#sendRequest').click(function(){

      $.ajax({
        url: "/requests/new",
        dataType: "html",
        type: "GET",
        data: {market_id: $("#market_id").val()},
        success: function(data, success) {
          $('#modal-content').empty()
          $('#modal-content').append(data);
        },
        error: function(data, failure) {
          alert(data);
        }
      });
    });

    $("#stores_next").on('click',function() {
      $.ajax({
        url: "/markets/"+ $("#market_id").val() +"/stores",
        dataType: "html",
        type: "GET",
        data: "current_store_page=" + $("#current_store_page").val(),
        success: function(data, success) {
          $('#market_stores').append(data);
          $('#current_store_page').val(parseInt($("#current_store_page").val()) + 1);
        },
        error: function(data, failure) {
          alert(success);
        }
      });
    });

    $("#reviews_next").on('click',function() {
      $.ajax({
        url: "/markets/"+ $("#market_id").val() +"/reviews",
        dataType: "html",
        type: "GET",
        data: "current_review_page=" + $("#current_review_page").val(),
        success: function(data, success) {
          $('#market_reviews').append(data);
          $('#current_review_page').val(parseInt($("#current_review_page").val()) + 1);
        },
        error: function(data, failure) {
          alert(success);
        }
      });
    });

    var clickEvent = false;
    $('#market_details').on('click', '.nav a', function() {
      clickEvent = true;
      $('.nav li').removeClass('active');
      $(this).parent().addClass('active');
    }).on('slid.bs.carousel', function(e) {
      if(!clickEvent) {
        var count = $('.nav').children().length -1;
        var current = $('.nav li.active');
        current.removeClass('active').next().addClass('active');
        var id = parseInt(current.data('slide-to'));
        if(count == id) {
          $('.nav li').first().addClass('active');
        }
      }
      clickEvent = false;
    });
  });
  </script>
